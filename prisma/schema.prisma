// Prisma Schema untuk Sistem POS PT. Indoagustus
// Dual Database: Pusat (Jember) & Cabang (Bondowoso)

generator client {
  provider = "prisma-client-js"
}

// NOTE: Ganti dengan env("DATABASE_URL") untuk production
datasource db {
  provider = "postgresql"
  url      = "postgresql://postgres:postgres@localhost:5432/pos_pusat?schema=public"
}

// ========================
// ENUMS
// ========================

enum Lokasi {
  PUSAT
  CABANG_BONDOWOSO
}

enum StatusSinkronisasi {
  PENDING
  SYNCED
  FAILED
}

enum TipeData {
  PRODUK
  TRANSAKSI
}

enum ArahReplikasi {
  PUSAT_KE_CABANG
  CABANG_KE_PUSAT
}

// ========================
// MODELS
// ========================

/// Kategori produk: Sembako, Minuman, Makanan, Kebersihan
model Kategori {
  id        String   @id @default(uuid())
  nama      String   @unique
  deskripsi String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  produk Produk[]

  @@map("kategori")
}

/// Master data produk - dikelola dari Pusat
model Produk {
  id          String   @id @default(uuid())
  kodeProduk  String   @unique @map("kode_produk")
  namaProduk  String   @map("nama_produk")
  kategoriId  String   @map("kategori_id")
  hargaDasar  Decimal  @map("harga_dasar") @db.Decimal(12, 2)
  isAktif     Boolean  @default(true) @map("is_aktif")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  kategori        Kategori          @relation(fields: [kategoriId], references: [id])
  stok            Stok[]
  detailTransaksi DetailTransaksi[]

  @@map("produk")
}

/// Stok produk per lokasi
model Stok {
  id          String   @id @default(uuid())
  produkId    String   @map("produk_id")
  lokasi      Lokasi
  jumlah      Int      @default(0)
  lastUpdated DateTime @default(now()) @map("last_updated")

  produk Produk @relation(fields: [produkId], references: [id])

  @@unique([produkId, lokasi])
  @@map("stok")
}

/// Header transaksi penjualan
model Transaksi {
  id              String              @id @default(uuid())
  nomorTransaksi  String              @map("nomor_transaksi")
  lokasiCabang    String              @map("lokasi_cabang")
  tanggal         DateTime            @default(now())
  totalHarga      Decimal             @map("total_harga") @db.Decimal(12, 2)
  statusSync      StatusSinkronisasi  @default(PENDING) @map("status_sync")
  requestId       String              @unique @map("request_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  detailTransaksi DetailTransaksi[]

  @@unique([nomorTransaksi, lokasiCabang])
  @@map("transaksi")
}

/// Detail item dalam transaksi
model DetailTransaksi {
  id          String  @id @default(uuid())
  transaksiId String  @map("transaksi_id")
  produkId    String  @map("produk_id")
  qty         Int
  hargaJual   Decimal @map("harga_jual") @db.Decimal(12, 2)

  transaksi Transaksi @relation(fields: [transaksiId], references: [id], onDelete: Cascade)
  produk    Produk    @relation(fields: [produkId], references: [id])

  @@map("detail_transaksi")
}

/// Log aktivitas sinkronisasi antar database
model LogSinkronisasi {
  id             String         @id @default(uuid())
  tipeData       TipeData       @map("tipe_data")
  arahReplikasi  ArahReplikasi  @map("arah_replikasi")
  status         StatusSinkronisasi
  retryCount     Int            @default(0) @map("retry_count")
  lastAttempt    DateTime       @default(now()) @map("last_attempt")
  errorMessage   String?        @map("error_message")
  referenceId    String?        @map("reference_id")
  createdAt      DateTime       @default(now()) @map("created_at")

  @@map("log_sinkronisasi")
}
